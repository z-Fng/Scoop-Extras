name: Check and Fix GitHub Redirects

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * *'  # Daily at 00:00 UTC

jobs:
  fix-github-redirects:
    name: Check and Fix GitHub  Redirects
    runs-on: windows-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@main
        with:
          path: my_bucket
          fetch-depth: 1
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Check GitHub Repository Redirects
        shell: pwsh
        working-directory: my_bucket
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          $repoSet = [System.Collections.Generic.HashSet[string]]::new()

          Get-ChildItem 'bucket' -Filter '*.json' -File | ForEach-Object {
            $content = Get-Content $_.FullName -Raw
            # Match only:
            # 1. https?://github.com/<owner>/<repo>
            # 2. https?://api.github.com/repos/<owner>/<repo>
            $matchResult = $content | Select-String -Pattern 'https?://(api\.github\.com/repos/|github\.com/)([^/"\s]+)/([^/"\s]+?)(?=\.git(?:[/?#]|$)|[/?#]|$)' -AllMatches
            if ($matchResult) {
              $matchResult.Matches | ForEach-Object {
                $owner = $_.Groups[2].Value
                $repo = $_.Groups[3].Value
                $repoSet.Add("$owner/$repo") | Out-Null
              }
            }
          }

          Write-Host "Found $($repoSet.Count) unique GitHub repositories.`n"

          # GitHub token from environment
          $token = $env:GITHUB_TOKEN
          if ($token) {
              Write-Host "Using GitHub GraphQL API with authentication."
          } else {
              Write-Host "Error: GITHUB_TOKEN not found."
              exit 1
          }

          $repoList = @($repoSet.GetEnumerator() | ForEach-Object { $_ })
          $redirects = @{}

          # Split into batches of 100 repos (GraphQL limit)
          $batchSize = 100
          $batches = [Math]::Ceiling($repoList.Count / $batchSize)

          Write-Host "Checking in $batches batches of $batchSize repos each.`n"

          for ($batch = 0; $batch -lt $batches; $batch++) {
              $start = $batch * $batchSize
              $end = [Math]::Min($start + $batchSize - 1, $repoList.Count - 1)
              $currentBatch = $repoList[$start..$end]

              # Build GraphQL query with aliases
              $queryParts = @("query {")
              $repoIndex = 0

              foreach ($repo in $currentBatch) {
                  $parts = $repo -split '/'
                  $owner = $parts[0]
                  $name = $parts[1]
                  $alias = "repo$repoIndex"
                  $queryParts += "  $($alias): repository(owner: `"$owner`", name: `"$name`") { owner { login } name }"
                  $repoIndex++
              }

              $queryParts += "}"
              $graphqlQuery = $queryParts -join "`n"

              try {
                  $headers = @{
                      "Authorization" = "Bearer $token"
                      "Accept" = "application/vnd.github.v3+json"
                  }

                  $body = @{
                      query = $graphqlQuery
                  } | ConvertTo-Json

                  Write-Host "Processing batch $($batch + 1)/$batches, repos $($start + 1)-$($end + 1)..."

                  $response = Invoke-WebRequest -Uri "https://api.github.com/graphql" -Method Post -Headers $headers -Body $body -TimeoutSec 30
                  $data = $response.Content | ConvertFrom-Json

                  # Get rate limit info from response headers
                  $rateLimitUsed = $response.Headers['X-RateLimit-Used']
                  $rateLimitLimit = $response.Headers['X-RateLimit-Limit']

                  Write-Host "  Rate Limit: $rateLimitUsed of $rateLimitLimit."

                  # Check each repository response
                  $repoIndex = 0
                  foreach ($repo in $currentBatch) {
                      $alias = "repo$repoIndex"
                      $result = $data.data.$alias

                      if ($result) {
                          $actualRepo = "$($result.owner.login)/$($result.name)"

                          # Check if it was redirected (requested repo != actual repo)
                          if ($actualRepo -ne $repo) {
                              $oldUrl = "https://github.com/$repo"
                              $newUrl = "https://github.com/$actualRepo"
                              $redirectKey = "$oldUrl -> $newUrl"
                              $redirects[$redirectKey] = ++$redirects[$redirectKey]
                              Write-Host "  ✓ Found: $redirectKey."
                          }
                      } else {
                          # GraphQL returned null - repo is gone
                          Write-Host "  ✗ Unreachable: https://github.com/$repo"
                      }

                      $repoIndex++
                  }
              } catch {
                  Write-Host "  Error in batch $($batch + 1): $($_.Exception.Message)"
              }

              # Add delay between batches to avoid rate limiting
              Start-Sleep -Seconds 2
          }

          Write-Host "`n=== Checked: $($repoList.Count) repositories ==="
          Write-Host "=== Found: $($redirects.Count) redirects ===`n"
          Write-Host "=== Redirect Details ==="
          $redirects.GetEnumerator() | ForEach-Object {
            Write-Host "Found: $($_.Key)"
          }

          # Save redirects to file for next step (in working directory)
          $redirectsFile = "../redirects.json"
          $redirects | ConvertTo-Json | Out-File -FilePath $redirectsFile -Encoding UTF8
          Write-Host "Redirects saved to: $redirectsFile"

      - name: Apply redirects to manifests
        shell: pwsh
        working-directory: my_bucket
        run: |
          $redirectsFile = "../redirects.json"
          Write-Host "Loading redirects from: $redirectsFile..."
          $redirects = Get-Content $redirectsFile | ConvertFrom-Json
          $changedFiles = @{}

          Write-Host "Applying redirects to bucket files...`n"

          Get-ChildItem 'bucket' -Filter '*.json' -File | ForEach-Object {
              $file = $_
              $content = Get-Content $file.FullName -Raw -Encoding UTF8
              $originalContent = $content
              $packageName = $file.BaseName

              foreach ($redirect in $redirects.PSObject.Properties) {
                  $parts = $redirect.Name -split ' -> '
                  $oldRepo = $parts[0] -replace 'https://github\.com/', ''
                  $newRepo = $parts[1] -replace 'https://github\.com/', ''

                  # Replace both formats (http and https):
                  # 1. http(s)://github.com/<owner>/<repo>
                  # 2. http(s)://api.github.com/repos/<owner>/<repo>
                  $escapedOldRepo = [regex]::Escape($oldRepo)
                  $oldUrl1 = "https?://github\.com/$escapedOldRepo"
                  $newUrl1 = "https://github.com/$newRepo"
                  $oldUrl2 = "https?://api\.github\.com/repos/$escapedOldRepo"
                  $newUrl2 = "https://api.github.com/repos/$newRepo"

                  $replaced = $false
                  foreach ($url in @($oldUrl1, $oldUrl2)) {
                      if ($content -match $url) {
                          $targetUrl = if ($url -match 'api\.github\.com/repos') { $newUrl2 } else { $newUrl1 }
                          $content = $content -replace $url, $targetUrl
                          Write-Host "$packageName`: replaced URL -> $targetUrl"
                          $replaced = $true
                      }
                  }
                  if ($replaced) {
                      $changedFiles[$packageName] = $true
                  }
              }

              # Only write if content changed
              if ($content -ne $originalContent) {
                  $content | Out-File -FilePath $file.FullName -Encoding UTF8 -NoNewline
              }
          }

          Write-Host "`nTotal files modified: $($changedFiles.Count)."

      - name: Commit and push changes
        shell: pwsh
        working-directory: my_bucket
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Configure git
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          # Get branch name from environment
          $branch = $env:GITHUB_REF_NAME
          Write-Host "Working on branch: $branch."

          # Pull latest changes with rebase first
          Write-Host "Pulling latest changes from remote..."
          git pull origin $branch --rebase --strategy-option theirs

          # Check if there are any changes after pulling
          $changedFiles = git diff --name-only bucket/
          if ($changedFiles) {
              Write-Host "Found changed files, creating commits..."

              # Get list of changed files
              $files = $changedFiles -split "`n"
              $fileCount = ($files | Where-Object { $_ -match 'bucket/.+\.json' }).Count

              if ($fileCount -eq 1) {
                  # Single file: use package name in commit message
                  foreach ($file in $files) {
                      if ($file -match 'bucket/(.+)\.json') {
                          $packageName = $matches[1]
                          $commitMessage = "$($packageName): Fix GitHub repository redirects"

                          Write-Host "Committing: $commitMessage"
                          git add $file
                          git commit -m $commitMessage
                      }
                  }
              } else {
                  # Multiple files: use generic commit message
                  $commitMessage = "(chore): Fix GitHub repository redirects"
                  Write-Host "Committing: $commitMessage"
                  git add bucket/
                  git commit -m $commitMessage
              }

              # Push all commits (normal push, no force needed)
              Write-Host "Pushing changes to remote..."
              git push origin $branch
          } else {
              Write-Host "No changes to commit."
          }
